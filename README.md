

## IoT Concepts

### MQTT คืออะไร 
โปรโตคอลสื่อสารแบบเบา (lightweight) ออกแบบมาสำหรับ IoT และอุปกรณ์ทรัพยากรจำกัด ใช้แบนด์วิดท์ต่ำ หน่วงต่ำ และทนเครือข่ายไม่เสถียร


### MQTT Connection Taxonomy

<p align="center">
  <img src="https://rightech.io/_next/image?url=%2Fdocs%2F19%2F1-1.webp&w=3840&q=95"
       width="600">
</p>
การทำความเข้าใจบทบาทขององค์ประกอบสำคัญ ได้แก่ Client, Broker และ Topic โดย Client สามารถทำหน้าที่เป็นทั้งผู้ส่ง (Publisher) และผู้รับข้อมูล (Subscriber) ได้ในเวลาเดียวกัน ส่วน Topic ทำหน้าที่เป็นช่องทางจัดหมวดหมู่ข้อมูลแบบลำดับชั้น (hierarchical) เพื่อให้การจัดการข้อมูลมีความชัดเจน

นอกจากนี้ Phase นี้ยังอธิบายเหตุผลที่ MQTT เหมาะกับระบบ IoT เช่น การใช้แบนด์วิดท์ต่ำ ขนาดแพ็กเก็ตเล็ก และสามารถทำงานได้ดีในสภาพเครือข่ายที่ไม่เสถียร ผู้เรียนควรสามารถอธิบายลำดับการไหลของข้อมูลตั้งแต่การส่งข้อมูลจากอุปกรณ์ต้นทาง ไปจนถึงการรับข้อมูลที่ปลายทางผ่าน Broker ได้อย่างถูกต้อง


Phase นี้เป็นการลงลึกในกลไกการทำงานของ MQTT ที่มีผลต่อความน่าเชื่อถือและพฤติกรรมของระบบโดยตรง โดยเริ่มจากแนวคิด Quality of Service (QoS) ซึ่งกำหนดระดับความมั่นใจในการส่งข้อความ ตั้งแต่การส่งแบบไม่รับประกัน ไปจนถึงการรับประกันการส่งเพียงครั้งเดียวจริง ผู้เรียนต้องสามารถเลือกใช้ QoS ให้เหมาะสมกับลักษณะของข้อมูล เช่น ข้อมูลเซ็นเซอร์ทั่วไปหรือคำสั่งควบคุมอุปกรณ์

นอกจากนี้ยังครอบคลุมแนวคิด Retained Message ซึ่งช่วยให้ Subscriber ที่เชื่อมต่อเข้ามาภายหลังสามารถรับค่าล่าสุดได้ทันที รวมถึงการจัดการ Session ทั้งแบบ Clean Session และ Persistent Session ซึ่งมีผลต่อการเก็บสถานะการเชื่อมต่อและข้อความที่พลาดไปในช่วงที่อุปกรณ์ออฟไลน์

Phase นี้ยังอธิบายการใช้ Wildcard Topic เพื่อเพิ่มความยืดหยุ่นในการรับข้อมูลหลายกลุ่มพร้อมกัน และกลไก Last Will and Testament (LWT) ซึ่งใช้ตรวจจับสถานะการเชื่อมต่อของอุปกรณ์เมื่อเกิดการหลุดออกจากระบบโดยไม่ปกติ ความเข้าใจในกลไกเหล่านี้เป็นหัวใจสำคัญในการออกแบบระบบ MQTT ที่มีความเสถียรและพร้อมใช้งานในระดับระบบจริง

## Embedded Systems


<p align="center">
  <img src="https://embarcados.com.br/wp-content/uploads/2018/07/rtos-scheduler-850x510.png"
       width="600">
</p>
RTOS (Real-Time Operating System) คือระบบปฏิบัติการที่ออกแบบมาสำหรับ Embedded Systems ซึ่งต้องการการตอบสนองที่มี เวลาแน่นอน (deterministic timing) ไม่ใช่แค่เร็ว แต่ต้อง คาดเดาเวลาได้ ว่าระบบจะตอบสนองภายในกี่มิลลิวินาที RTOS ถูกใช้ในระบบที่ต้องทำหลายงานพร้อมกัน เช่น อ่านเซ็นเซอร์ ควบคุมอุปกรณ์ สื่อสารเครือข่าย และจัดการเหตุการณ์แบบ real-time

### แนวคิดหลักของ RTOS

หัวใจของ RTOS คือการแบ่งการทำงานออกเป็น Task (Thread) หลายตัว โดยแต่ละ Task ทำหน้าที่เฉพาะ เช่น
* Task อ่านข้อมูลเซ็นเซอร์
* Task สื่อสาร (UART, SPI, MQTT)
* Task ควบคุม Actuator
RTOS จะใช้ Scheduler ในการจัดลำดับการทำงานของ Task ตาม Priority ทำให้ Task ที่สำคัญกว่าได้รับการประมวลผลก่อน ซึ่งแตกต่างจากโปรแกรมแบบ loop เดียว (Bare-metal) ที่ทุกอย่างต้องรอคิวกันเอง
### Scheduling และ Real-Time Behavior
RTOS รองรับการทำงานแบบ Preemptive Scheduling ซึ่งหมายความว่า Task ที่มี Priority สูงสามารถแทรกการทำงานของ Task ที่ Priority ต่ำได้ทันที สิ่งนี้ทำให้ RTOS เหมาะกับงานที่มีข้อกำหนดด้านเวลา เช่น
* ควบคุมมอเตอร์
* ระบบเตือนภัย
* การสื่อสารที่ต้องตอบสนองทันที
ในระบบ Real-Time จะให้ความสำคัญกับ ความแน่นอนของเวลา มากกว่าความเร็วสูงสุด
### การสื่อสารระหว่าง Task
RTOS มีเครื่องมือสำหรับการสื่อสารและซิงโครไนซ์ระหว่าง Task เช่น
* Queue: ส่งข้อมูลระหว่าง Task อย่างเป็นระเบียบ
* Semaphore / Mutex: ป้องกันการเข้าถึงทรัพยากรร่วมพร้อมกัน
* Event Group: ใช้แจ้งเหตุการณ์ระหว่าง Task
กลไกเหล่านี้ช่วยลดปัญหา race condition และทำให้โค้ดมีโครงสร้างที่ชัดเจน

## Communication & Networking
<p>
<img width="1540" height="590" alt="image" src="https://github.com/user-attachments/assets/3a0151eb-63e4-4437-ad24-ca2ef44fc496" />
</p>

WebSocket คือโปรโตคอลสื่อสารแบบ Real-time, Two-way communication ที่ทำงานบน TCP โดยเปิดการเชื่อมต่อค้างไว้ระหว่างอุปกรณ์ IoT กับ Server ทำให้สามารถส่งและรับข้อมูลได้ทันทีโดยไม่ต้องเปิด–ปิดการเชื่อมต่อซ้ำเหมือน HTTP แบบเดิม WebSocket จึงเหมาะกับระบบ IoT ที่ต้องการการอัปเดตข้อมูลต่อเนื่องและตอบสนองเร็ว

### หลักการทำงาน
WebSocket เริ่มต้นจากการเชื่อมต่อแบบ HTTP (Handshake) แล้วอัปเกรดเป็น WebSocket จากนั้นการสื่อสารจะเป็นแบบ Full-duplex คือ
* Server ส่งข้อมูลหา Device ได้ทันที
* Device ส่งข้อมูลกลับ Server ได้ทันที
โดยไม่ต้องรอ request ใหม่ ทำให้ latency ต่ำและเหมาะกับงาน real-time

### บทบาทของ WebSocket ใน IoT
ในระบบ IoT WebSocket มักถูกใช้ในสถานการณ์ เช่น
* ส่งข้อมูลเซ็นเซอร์แบบ real-time ไปยัง Dashboard
* ควบคุมอุปกรณ์ (on/off, config) จากเว็บ
* แจ้งเตือนสถานะอุปกรณ์ (online/offline, error)
* Streaming ข้อมูลต่อเนื่อง (ค่าพลังงาน, อุณหภูมิ)
  
WebSocket จึงเชื่อม IoT Device ↔ Backend ↔ Web Application ได้โดยตรง
### ข้อจำกัดและสิ่งที่ต้องระวัง
* ใช้พลังงานมากกว่า MQTT ในอุปกรณ์พลังงานต่ำ
* ไม่เหมาะกับเครือข่ายที่ไม่เสถียรหรือ sleep บ่อย
* ไม่มี QoS และ retained message แบบ MQTT
* ต้องจัดการ reconnect เองเมื่อ connection หลุด

ดังนั้น WebSocket ไม่เหมาะกับ sensor node ขนาดเล็กที่ใช้แบตเตอรี่ยาวๆ

## Software & Programming

### Node-RED
<p align="center">
<img align="center" width="250" height="250" alt="image" src="https://github.com/user-attachments/assets/1a2a923b-b675-4ac8-b3a8-6f113f01ca49" />
</p>

เป็นเครื่องมือพัฒนาแบบ Flow-based Programming ที่ใช้การลาก–เชื่อม node เพื่อสร้างระบบประมวลผลข้อมูล เหมาะกับงาน IoT เพราะลดความซับซ้อนของโค้ด และเชื่อมต่ออุปกรณ์ โปรโตคอล และบริการต่างๆ ได้รวดเร็ว
### แนวคิดการทำงาน
Node-RED ทำงานบนแนวคิด Flow โดยแต่ละ Flow คือสายงานของข้อมูลตั้งแต่รับเข้า → ประมวลผล → ส่งออก
องค์ประกอบหลัก:
* Input Node: รับข้อมูล (MQTT, HTTP, Serial, TCP)
* Function Node: ประมวลผลด้วย JavaScript
* Output Node: ส่งข้อมูล (Dashboard, Database, API)

การไหลของข้อมูลเป็นแบบ event-driven เหมาะกับข้อมูลจากเซ็นเซอร์ที่มาเป็นช่วงๆ
### บทบาทของ Node-RED ใน IoT
Node-RED มักถูกใช้เป็น ตัวกลาง (Integration Layer) ระหว่างอุปกรณ์ IoT กับระบบปลายทาง เช่น

* รับข้อมูลจาก MQTT Broker
* แปลง/กรองข้อมูล
* บันทึกลงฐานข้อมูล
* แสดงผลแบบ real-time บน Dashboard
* ส่งแจ้งเตือนเมื่อเกิดเงื่อนไขผิดปกติ

ช่วยลดเวลาพัฒนาและทำให้ระบบปรับแก้ได้ง่าย

### ข้อจำกัด
* ไม่เหมาะกับระบบที่ต้อง performance สูงมาก
* Flow ใหญ่เกินไปจะดูแลยาก
* Logic ซับซ้อนมากอาจอ่านยากกว่าโค้ดปกติ
* ต้องจัดการ security และ version control ให้ดี

### การใช้งานจริงที่พบบ่อย
* Smart Home / Smart Farm
* Monitoring ระบบอุตสาหกรรม
* IoT Dashboard แบบ real-time
* Data pipeline ขนาดเล็ก
* Rapid prototype
